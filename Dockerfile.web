FROM cirrusci/flutter:stable AS builder

WORKDIR /app

# Create a non-root user and ensure ownership to avoid running flutter as root
RUN useradd -m builder || true

# Copy only pubspec first to leverage layer caching for dependencies
COPY pubspec.* ./

# Ensure the /app is owned by the non-root user before running pub get
RUN chown -R builder:builder /app

# Run dependency fetch as non-root
USER builder
RUN flutter pub get

# Switch back to root to copy the rest of the repository (keeps permissions controllable)
USER root

# Copy the rest of the project and set ownership for the builder user
COPY . .
RUN chown -R builder:builder /app

# Build web release as the non-root builder user
USER builder
RUN flutter build web --release

FROM nginx:stable-alpine

# Replace default nginx config with our SPA-friendly config
COPY nginx.conf /etc/nginx/conf.d/default.conf

# Copy built web output from builder stage
COPY --from=builder /app/build/web /usr/share/nginx/html

EXPOSE 80
CMD ["nginx", "-g", "daemon off;"]
